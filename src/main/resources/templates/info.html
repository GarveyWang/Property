<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="dashboard">

<head>
    <title>政策公告</title>
    <link href="../static/css/bootstrap/fileinput.min.css" rel="stylesheet">
    <link href="../static/css/bootstrap/bootstrap-toggle.min.css" rel="stylesheet">
</head>
<body>
<h2 layout:fragment="title">
    政策公告
</h2>
<div layout:fragment="content" style="width:90%;">
    <div id="displayInfoPanel">
        <div class="clearfix" style="margin-bottom: 10px">
            <div style="float: right">
                <button th:if="${user.canPublishInfo()}" class="btn btn-default" id="publishInfoBtn" onclick="showPublishInfoPanel()">
                    发布公告
                </button>
                <label for="hideOrShowInfoTrigger">显示隐藏公告</label>
                <input id="hideOrShowInfoTrigger" data-toggle="toggle" data-on="是" data-off="否" type="checkbox" onchange="hideOrShowInfo()">
            </div>
        </div>
        <div th:each="info,iterstat: ${infoList}">
            <div class="info panel panel-default col-sm-6" th:id="'info'+${info.idx}" th:attr = "visible = ${info.prop.visible}">
                <div class="panel-heading">
                    <h3 class="panel-title" th:text="${info.title}">标题</h3>
                </div>
                <div class="panel-body">
                    <input type="hidden" th:id="'title'+${info.idx}" th:value="${info.title}">
                    <input type="hidden" th:id="'content'+${info.idx}" th:value="${info.content}">
                    <input type="hidden" th:id="'fileCount'+${info.idx}" th:value="${info.attachments.size()}">
                    <div th:each="fileHash,fileStat : ${info.attachments}" th:if="${not #maps.isEmpty(info.attachments)}">
                        <input type="hidden" th:id="'file-'+${info.idx} + '-' +${fileStat.index}" th:attr="fileHash = ${fileStat.current.key}, fileName = ${fileStat.current.value}">
                    </div>

                    <p th:text="${info.content}" style="display: -webkit-box;-webkit-line-clamp: 1;-webkit-box-orient: vertical;overflow: hidden;">内容</p>
                    <HR style="FILTER: alpha(opacity = 0,finishopacity = 100,style = 1)" width="100%" color=#333333 SIZE=3>
                    <div class="clearfix">
                        <small>发布于<span th:text="${#dates.format(info.timestamp, 'yyyy-MM-dd HH:mm:ss')}"></span></small>
                        <button class="btn btn-default" onclick="showDetail(this)" style="float:right" th:attr = "idx = ${info.idx}">
                            查看详情
                        </button>
                        <button th:if="${user.canPublishInfo() && info.prop.visible == 0}" class="btn btn-default invisibleInfo" onclick="showInfo(this)" style="float:right" th:attr = "idx = ${info.idx}">
                            恢复公告
                        </button>
                        <button th:if="${user.canPublishInfo() && info.prop.visible == 1}" class="btn btn-default visibleInfo" onclick="hideInfo(this)" style="float:right" th:attr = "idx = ${info.idx}">
                            隐藏公告
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="publishInfoPanel" class="form-horizontal" hidden="hidden">
        <h3  class="col-sm-offset-1" style="text-align: center"><b>发布公告</b></h3>
        <div class="form-group">
            <label for="infoTitle" class="col-sm-1 control-label">标题</label>
            <div class="col-sm-11">
                <input type="text" name="title" class="form-control" id="infoTitle" placeholder="请输入标题">
            </div>
        </div>
        <div class="form-group">
            <label for="infoContent" class="col-sm-1 control-label">内容</label>
            <div class="col-sm-11">
                <textarea rows="8" name="content" class="form-control" id="infoContent" placeholder="请输入内容"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label for="attachments" class="col-sm-1 control-label">添加附件</label>
            <div class="col-sm-11 form-inline">
                <input id="attachments" multiple type="file" name="attachments" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-10 col-sm-2">
                <button class="btn btn-default" onclick="showDisplayInfoPanel()">取消</button>
                <button class="btn btn-primary" onclick="submitInfo()">发布</button>
            </div>
        </div>
    </div>

    <div id="detailInfoPanel" hidden="hidden">
        <button class="btn btn-default" onclick="showDisplayInfoPanel()">←返回</button>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title" id="detailTitle"></h3>
            </div>
            <div class="panel-body">
                <p id="detailContent"></p>
            </div>
            <div class="panel-footer" id="detailFiles">
            </div>
        </div>
    </div>

</div>
<th:block layout:fragment="bottomScriptBlock">
    <script type="text/javascript" src="../static/js/bootstrap/fileinput.min.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap/fileinput-locale-zh.js"></script>
    <script type="text/javascript" src="../static/js/bootstrap/bootstrap-toggle.min.js"></script>
    <script type="text/javascript">
        $(function () {
            $('.nav-item').children('ul').slideUp(300);
            $("#infoNav").slideDown(300);
            $("#infoNav").parent('li').addClass('nav-show').siblings('li').removeClass('nav-show');
            
            $(".info").each(function () {
                if ($(this).attr("visible")==0){
                    $(this).hide();
                }
            });

            $("#attachments").fileinput({
                language: 'zh', //设置语言
                uploadUrl: "/publicity/uploadInfo", //上传的地址
                allowedFileExtensions: ['jpg', 'gif', 'png','doc','docx','pdf','ppt','pptx','txt','xls','xlsx'],//接收的文件后缀
                uploadAsync: false, //默认异步上传
                showUpload: false, //是否显示上传按钮
                showRemove : true, //显示移除按钮
                showPreview : true, //是否显示预览
                showCaption: false,//是否显示标题
                browseClass: "btn btn-primary", //按钮样式
                //dropZoneEnabled: true,//是否显示拖拽区域
                //minImageWidth: 50, //图片的最小宽度
                //minImageHeight: 50,//图片的最小高度
                //maxImageWidth: 1000,//图片的最大宽度
                //maxImageHeight: 1000,//图片的最大高度
                maxFileSize: 10000,//单位为kb，如果为0表示不限制文件大小
                //minFileCount: 0,
                //maxFileCount: 10, //表示允许同时上传的最大文件个数
                enctype: 'multipart/form-data',
                validateInitialCount:true,
                previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
                msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
                layoutTemplates :{
                    // actionDelete:'', //去除上传预览的缩略图中的删除图标
                    actionUpload:'',//去除上传预览缩略图中的上传图片；
                    actionZoom:''   //去除上传预览缩略图中的查看详情预览的缩略图标。
                },
                uploadExtraData:function () {
                    return {
                        "title": $("#infoTitle").val(),
                        "content": $("#infoContent").val()
                    };
                }
            }).on("filebatchuploadsuccess", function (event, data, previewId, index) {
                alert('公告发布成功！');
                window.location.href="/publicity/info";
            }).on('filebatchuploaderror', function(event, data, msg) {
                alert('公告发布失败！');
            });

            var info = "[[${info}]]";
            if (info != null && info.length>0){
                alert(info);
            }
        });
        function submitInfo() {
            $("#attachments").fileinput("upload");
        }
        function hideOrShowInfo() {
            if ($("#hideOrShowInfoTrigger").prop("checked")){
                $(".info").each(function () {
                    if ($(this).attr("visible")==0){
                        $(this).show();
                    }else{
                        $(this).hide();
                    }
                });
            } else{
                $(".info").each(function () {
                    if ($(this).attr("visible")==0){
                        $(this).hide();
                    }else{
                        $(this).show();
                    }
                });
            }
        }
        function showInfo(obj) {
            $.ajax({
                type:"POST",
                url:"/publicity/updateInfoProp",
                contentType : 'application/json',
                dataType : 'json',
                data:JSON.stringify({
                    "idx":$(obj).attr("idx"),
                    "visible":1
                }),
                success:function (data) {
                    alert("恢复成功");
                    var infoId = "#info" + $(obj).attr("idx");
                    $(infoId).attr("visible",1);
                    $(infoId).hide();
                    $(obj).removeClass("invisibleInfo");
                    $(obj).addClass("visibleInfo");
                    $(obj).removeAttr("onclick");
                    $(obj).attr("onclick","hideInfo(this)");
                    $(obj).html("隐藏公告");
                }
            })
        }
        function hideInfo(obj) {
            $.ajax({
                type:"POST",
                url:"/publicity/updateInfoProp",
                contentType : 'application/json',
                dataType : 'json',
                data:JSON.stringify({
                    "idx":$(obj).attr("idx"),
                    "visible":0
                }),
                success:function (data) {
                    alert("隐藏成功");
                    var infoId = "#info" + $(obj).attr("idx");
                    $(infoId).attr("visible",0);
                    $(infoId).hide();
                    $(obj).removeClass("visibleInfo");
                    $(obj).addClass("invisibleInfo");
                    $(obj).removeAttr("onclick");
                    $(obj).attr("onclick","showInfo(this)");
                    $(obj).html("恢复公告");
                }
            })
        }
        function showPublishInfoPanel() {
            $("#detailInfoPanel").hide();
            $("#displayInfoPanel").hide();
            $("#publishInfoPanel").show();
        }
        function showDisplayInfoPanel() {
            $("#detailInfoPanel").hide();
            $("#publishInfoPanel").hide();
            $("#displayInfoPanel").show();
        }
        function showDetail(info){
            $("#publishInfoPanel").hide();
            $("#displayInfoPanel").hide();
            var idx = $(info).attr("idx");
            $("#detailTitle").html($("#title"+idx).val());
            $("#detailContent").html($("#content"+idx).val());
            var fileCount = $("#fileCount" + idx).val();
            if (fileCount == 0){
                $("#detailFiles").hide();
            } else{
                var ul = '<p>附件</p><ul class="list-group">';
                for (var i= 0; i<fileCount; ++i){
                    var fileId = "#file-"+idx+"-"+i;
                    var fileHash = $(fileId).attr("fileHash");
                    var fileName = $(fileId).attr("fileName");
                    ul += '<li class="list-group-item">';
                    ul += '<a onclick="downloadFile(\'' + fileHash + '\',\'' + fileName +'\')" >';
                    ul += fileName;
                    ul += '</a></li>';
                }
                ul += '</ul>'
                $("#detailFiles").html(ul);
                $("#detailFiles").show();
            }
            $("#detailInfoPanel").show();
        }
        function downloadFile(fileHash, fileName) {
            var form=$("<form>");
            form.attr("style","display:none");
            form.attr("target","");
            form.attr("method","post");
            form.attr("action","/download");

            var fileHashInput = $("<input>")
            fileHashInput.attr("type","text");
            fileHashInput.attr("name","fileHash");
            fileHashInput.attr("value",fileHash);
            form.append(fileHashInput);

            var fileNameInput = $("<input>")
            fileNameInput.attr("type","text");
            fileNameInput.attr("name","fileName");
            fileNameInput.attr("value",fileName);
            form.append(fileNameInput);

            $("body").append(form);
            form.submit();
        }
    </script>
</th:block>
</body>
</html>